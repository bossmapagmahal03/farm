<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farm Production Management â€” Livestock (Responsive Single-File Demo)</title>
  <meta name="theme-color" content="#2f6f3e" />
  <!-- Chart.js CDN (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <style>
  /* Embedded styles (nature theme, responsive) */
  :root{
    --bg:#f3f6f0;
    --card:#ffffff;
    --primary:#2f6f3e;
    --accent:#6aa84f;
    --muted:#6b6b6b;
    --glass: rgba(255,255,255,0.95);
    --radius:10px;
    --max-w:1200px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    color: #1d2b20;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: linear-gradient(180deg, #eef6ea 0%, var(--bg) 100%);
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
    padding:16px;
    gap:14px;
  }
  .site-header{
    width:100%;
    max-width:var(--max-w);
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:var(--glass);
    border-radius:var(--radius);
    padding:10px 12px;
    gap:8px;
  }
  .brand{font-weight:700;color:var(--primary);cursor:pointer;display:flex;align-items:center;gap:8px}
  .logo{font-size:20px}
  .hamburger{display:none;background:transparent;border:none;font-size:20px;color:var(--primary);padding:8px;border-radius:8px}
  .main-nav{display:flex;align-items:center;gap:12px;width:100%}
  .nav-left{display:flex;gap:8px;flex-wrap:wrap}
  .nav-right{display:flex;align-items:center;gap:8px}
  .nav-btn{background:transparent;border:1px solid transparent;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--primary);font-weight:600}
  .nav-btn.active{background:var(--accent);color:white}
  .login-btn{background:var(--primary);color:white;border:none;padding:8px 10px;border-radius:8px}
  .small{font-size:13px}
  .muted{color:var(--muted)}
  .app-root{width:100%;max-width:var(--max-w);padding:6px}
  .panel{background:var(--card);border-radius:12px;padding:16px;margin-bottom:12px;box-shadow: 0 8px 30px rgba(15,30,10,0.05)}
  .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  input, select, textarea, button{font:inherit}
  input, select, textarea{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e6efe0}
  .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .primary{background:var(--primary);color:white;padding:8px 12px;border:none;border-radius:8px}
  .ghost{background:transparent;border:1px solid #ddd;padding:8px 12px;border-radius:8px}
  .table-responsive{overflow-x:auto}
  .table{width:100%;border-collapse:collapse;min-width:600px}
  .table th,.table td{padding:8px 10px;border-bottom:1px solid #f0f2ef;text-align:left}
  .chatbot{position:fixed;right:20px;bottom:20px;width:320px;max-height:70vh;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;box-shadow:0 20px 40px rgba(20,40,12,0.2);transform:translateY(0);z-index:1200}
  .chatbot.closed{transform:translateY(36px);opacity:0.9}
  .chat-header{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .chat-body{padding:10px;background:linear-gradient(180deg,#fbfff9,#f6fbf2);flex:1;overflow:auto}
  .chat-input{display:flex;gap:8px;padding:8px;background:linear-gradient(180deg,#ffffffcc,#f6fbf2)}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:1100}
  .hidden{display:none}
  .modal{width:100%;max-width:420px;background:var(--card);border-radius:12px;padding:18px}
  .site-footer{width:100%;max-width:var(--max-w);display:flex;justify-content:space-between;padding:12px 18px;color:var(--muted);font-size:14px}
  @media (max-width:900px) {
    .hamburger{display:inline-flex}
    .nav-left{display:none}
    .main-nav{gap:8px}
    .app-root{padding:8px}
    .table{min-width:0}
    .chatbot{right:12px;width:92%}
    .modal{margin:12px;height:calc(100vh - 48px);overflow:auto}
  }
  .mobile-nav-panel{
    display:none;position:fixed;left:0;right:0;top:60px;background:var(--card);box-shadow:0 8px 30px rgba(15,30,10,0.12);border-bottom-left-radius:12px;border-bottom-right-radius:12px;z-index:1150;padding:10px;
  }
  .mobile-nav-panel.open{display:block}
  .mobile-nav-panel .nav-btn{display:block;width:100%;text-align:left;padding:10px 12px;margin-bottom:6px}
  .kv{display:flex;justify-content:space-between;align-items:center;gap:12px}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand" id="brand" onclick="navigate('dashboard')">
      <span class="logo" aria-hidden="true">ðŸŒ¿</span>
      <span class="brand-text">Farm Production Management â€” Livestock</span>
    </div>

    <button id="hamburger" class="hamburger" aria-label="Open navigation" onclick="toggleMobileNav()">â˜°</button>

    <nav class="main-nav" id="main-nav" aria-label="Primary">
      <div class="nav-left">
        <button class="nav-btn" id="nav-dashboard" onclick="navigate('dashboard')">Dashboard</button>
        <button class="nav-btn" id="nav-mylivestock" onclick="navigate('mylivestock')">My Livestock</button>
        <button class="nav-btn" id="nav-feed" onclick="navigate('feed')">Feed</button>
        <button class="nav-btn" id="nav-production" onclick="navigate('production')">Production</button>
        <button class="nav-btn" id="nav-health" onclick="navigate('health')">Health</button>
        <button class="nav-btn" id="nav-inventory" onclick="navigate('inventory')">Inventory</button>
        <button class="nav-btn" id="nav-reports" onclick="navigate('reports')">Reports</button>
      </div>

      <div id="admin-actions" class="admin-only" style="display:none">
        <button class="nav-btn" id="nav-users" onclick="navigate('users')">User Management</button>
        <button class="nav-btn" id="nav-settings" onclick="navigate('settings')">Settings</button>
      </div>

      <div class="nav-right">
        <span id="current-user" class="small muted" aria-live="polite"></span>
        <a class="login-btn" href="farm.html">Log In</a>
      </div>
    </nav>
  </header>

  <main id="app" class="app-root" aria-live="polite"></main>

  <!-- Login Modal -->
  <div id="modal" class="overlay hidden" onclick="closeLogin(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 id="modal-title">Log In</h3>
      <form id="login-form" onsubmit="login(event)">
        <label>Username<br/>
          <input id="login-username" required autocomplete="username" />
        </label>
        <label>Password<br/>
          <input id="login-password" type="password" required autocomplete="current-password" />
        </label>
        <div class="modal-actions" style="margin-top:12px">
          <button class="primary" type="submit">Sign in</button>
          <button type="button" class="ghost" onclick="closeLogin()">Cancel</button>
        </div>
        <p class="small muted" style="margin-top:8px">Demo: admin / adminpass â€” user / userpass. Data stored locally (localStorage).</p>
      </form>
    </div>
  </div>

  <!-- Mobile nav panel (created by JS if needed) -->
  <div id="mobile-nav-placeholder"></div>

  <!-- Chatbot (UI-only demo) -->
  <div id="chatbot" class="chatbot closed" aria-hidden="true">
    <div class="chat-header" onclick="toggleChat()">
      <span>FarmBot</span>
      <button class="mini" title="close" onclick="toggleChat(event)">âœ•</button>
    </div>
    <div class="chat-body" id="chat-body" role="log" aria-live="polite"></div>
    <form id="chat-form" class="chat-input" onsubmit="sendChat(event)">
      <input id="chat-input" placeholder="Ask about features or capstone recommendations..." />
      <button type="submit">Send</button>
    </form>
  </div>

  <footer class="site-footer">
    <div>Â© <span id="year"></span> Farm Production Management â€” Livestock (Demo)</div>
    <div class="footer-actions">
      <button onclick="toggleChat()">Help (FarmBot)</button>
    </div>
  </footer>

  <script>
  // Self-contained JavaScript (responsive + defensive)
  (function(){
    // Keys for demo localStorage
    const LS_PREFIX = 'farm_livestock_demo_v1_';
    const LS_USERS = LS_PREFIX + 'users';
    const LS_LIVESTOCK = LS_PREFIX + 'livestock';
    const LS_FEED = LS_PREFIX + 'feed';
    const LS_PROD = LS_PREFIX + 'production';
    const LS_HEALTH = LS_PREFIX + 'health';
    const LS_INV = LS_PREFIX + 'inventory';
    const LS_FIN = LS_PREFIX + 'financials';
    const LS_CHAT = LS_PREFIX + 'chat';

    const YEAR = new Date().getFullYear();
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = YEAR;

    let currentUser = null;
    let chatOpen = false;
    let mobileNavOpen = false;
    let chartInstance = null;

    const $ = s => document.querySelector(s);
    const $all = s => Array.from(document.querySelectorAll(s));
    const escapeHtml = s => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const generateId = (p='id') => p + '_' + Math.random().toString(36).slice(2,9);
    const read = (k, fb=[]) => { try { return JSON.parse(localStorage.getItem(k) || 'null') ?? fb; } catch(e) { return fb; } };
    const write = (k,v) => localStorage.setItem(k, JSON.stringify(v));

    // Seed initial demo data (only once)
    (function seed() {
      if (!read(LS_USERS).length) {
        write(LS_USERS, [
          { id: 'u_admin', username: 'admin', password: 'adminpass', role: 'admin', name: 'Administrator' },
          { id: 'u_user', username: 'user', password: 'userpass', role: 'user', name: 'Farm Staff' }
        ]);
      }
      if (!read(LS_LIVESTOCK).length) {
        write(LS_LIVESTOCK, [
          { id: generateId('a'), tag_id: 'TAG-001', type: 'Cow', breed: 'Friesian', dob: '2021-02-10', status: 'Active', notes: 'Milking' },
          { id: generateId('a'), tag_id: 'TAG-002', type: 'Goat', breed: 'Boer', dob: '2022-06-05', status: 'Pregnant', notes: '' }
        ]);
      }
      if (!read(LS_FEED).length) {
        write(LS_FEED, [
          { id: generateId('f'), name: 'Hay Bale', quantity: 120, unit: 'bales', low_stock_threshold: 10 },
          { id: generateId('f'), name: 'Concentrate', quantity: 250, unit: 'kg', low_stock_threshold: 20 }
        ]);
      }
      if (!read(LS_PROD).length) write(LS_PROD, []);
      if (!read(LS_HEALTH).length) write(LS_HEALTH, []);
      if (!read(LS_INV).length) write(LS_INV, []);
      if (!read(LS_FIN).length) write(LS_FIN, []);
    })();

    // Responsive mobile nav helpers
    function toggleMobileNav() {
      mobileNavOpen = !mobileNavOpen;
      if (mobileNavOpen) openMobileNavPanel(); else closeMobileNavPanel();
    }
    function openMobileNavPanel() {
      let panel = document.getElementById('mobile-nav-panel');
      if (!panel) {
        panel = document.createElement('div');
        panel.id = 'mobile-nav-panel';
        panel.className = 'mobile-nav-panel';
        panel.innerHTML = `
          <div class="mobile-nav-inner">
            <button class="nav-btn" onclick="navigate('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="navigate('mylivestock')">My Livestock</button>
            <button class="nav-btn" onclick="navigate('feed')">Feed</button>
            <button class="nav-btn" onclick="navigate('production')">Production</button>
            <button class="nav-btn" onclick="navigate('health')">Health</button>
            <button class="nav-btn" onclick="navigate('inventory')">Inventory</button>
            <button class="nav-btn" onclick="navigate('reports')">Reports</button>
            <div id="mobile-admin-actions" style="margin-top:10px;display:none">
              <button class="nav-btn" onclick="navigate('users')">User Management</button>
              <button class="nav-btn" onclick="navigate('settings')">Settings</button>
            </div>
          </div>`;
        document.body.appendChild(panel);
      }
      const adminPanel = document.getElementById('mobile-admin-actions');
      if (adminPanel) adminPanel.style.display = (currentUser && currentUser.role === 'admin') ? 'block' : 'none';
      panel.classList.add('open');
      panel.setAttribute('aria-hidden', 'false');
    }
    function closeMobileNavPanel() {
      const panel = document.getElementById('mobile-nav-panel');
      if (panel) { panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); }
      mobileNavOpen = false;
    }

    // Auth & header
    function openLogin() { $('#modal') && $('#modal').classList.remove('hidden'); $('#login-username') && $('#login-username').focus(); }
    function closeLogin(e) { if (e && e.stopPropagation) e.stopPropagation(); $('#modal') && $('#modal').classList.add('hidden'); }
    function login(e) {
      e.preventDefault();
      const username = $('#login-username')?.value?.trim();
      const password = $('#login-password')?.value;
      const users = read(LS_USERS);
      const u = users.find(x => x.username === username && x.password === password);
      if (!u) return alert('Invalid credentials (demo). Use admin/adminpass or user/userpass.');
      currentUser = { id: u.id, username: u.username, name: u.name, role: u.role };
      updateHeader();
      closeLogin();
      navigate('dashboard');
      closeMobileNavPanel();
    }
    function logout() { if (!confirm('Logout?')) return; currentUser = null; updateHeader(); navigate('dashboard'); closeMobileNavPanel(); }
    function updateHeader() {
      $('#current-user') && ($('#current-user').textContent = currentUser ? `${currentUser.name} (${currentUser.role})` : '');
      const btn = $('#btn-login');
      const adminActions = document.getElementById('admin-actions');
      if (btn) {
        if (currentUser) { btn.textContent = 'Logout'; btn.onclick = logout; } else { btn.textContent = 'Log In'; btn.onclick = openLogin; }
      }
      if (adminActions) adminActions.style.display = (currentUser && currentUser.role === 'admin') ? 'inline-block' : 'none';
      const mobileAdmin = document.getElementById('mobile-admin-actions');
      if (mobileAdmin) mobileAdmin.style.display = (currentUser && currentUser.role === 'admin') ? 'block' : 'none';
    }

    // Navigation (bind to global for mobile panel buttons)
    window.navigate = function(page) {
      $all('.nav-btn').forEach(b => b.classList.remove('active'));
      const desktopBtn = document.getElementById('nav-' + page);
      if (desktopBtn) desktopBtn.classList.add('active');
      closeMobileNavPanel();
      switch(page) {
        case 'mylivestock': renderMyLivestock(); break;
        case 'feed': renderFeed(); break;
        case 'production': renderProduction(); break;
        case 'health': renderHealth(); break;
        case 'inventory': renderInventory(); break;
        case 'reports': renderReports(); break;
        case 'users': renderUsers(); break;
        case 'settings': renderSettings(); break;
        default: renderDashboard();
      }
    };

    // Dashboard
    function renderDashboard() {
      const livestock = read(LS_LIVESTOCK);
      const feed = read(LS_FEED);
      const prod = read(LS_PROD);
      const alerts = feed.filter(f => f.quantity <= (f.low_stock_threshold || 5)).map(f => `Low feed: ${f.name} (${f.quantity} ${f.unit})`);
      const app = document.getElementById('app');
      if (!app) return;
      app.innerHTML = `
        <section class="panel">
          <h2>Dashboard</h2>
          <p class="small">Welcome${currentUser ? ', ' + currentUser.name : ''}. This demo stores data locally in your browser.</p>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
            <div style="background:#f8fff6;padding:12px;border-radius:10px;min-width:160px">
              <div class="small">Livestock</div><div style="font-weight:700;font-size:20px">${livestock.length}</div>
            </div>
            <div style="background:#fff6f0;padding:12px;border-radius:10px;min-width:160px">
              <div class="small">Feed items</div><div style="font-weight:700;font-size:20px">${feed.length}</div>
            </div>
            <div style="background:#f8f9ff;padding:12px;border-radius:10px;min-width:160px">
              <div class="small">Production records</div><div style="font-weight:700;font-size:20px">${prod.length}</div>
            </div>
          </div>

          <div style="margin-top:18px;display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start">
            <div style="flex:1;min-width:280px" class="panel">
              <h4>Production by Type</h4>
              <canvas id="dashboard-chart" style="height:200px;display:block"></canvas>
            </div>
            <div style="width:320px;min-width:220px" class="panel">
              <h4>Alerts</h4>
              ${alerts.length ? `<ul>${alerts.map(a=>`<li>${escapeHtml(a)}</li>`).join('')}</ul>` : '<div class="small muted">No active alerts.</div>'}
            </div>
          </div>
        </section>
      `;
      renderDashboardChart();
    }

    // Chart rendering with defensive guard if Chart isn't loaded
    function renderDashboardChart() {
      try {
        const prods = read(LS_PROD).slice(0,50);
        const map = {};
        prods.forEach(p => { map[p.type] = (map[p.type] || 0) + Number(p.amount || 0); });
        const labels = Object.keys(map);
        const data = labels.map(l => map[l]);
        const ctx = document.getElementById('dashboard-chart');
        if (!ctx) return;
        if (window.Chart) {
          if (chartInstance) chartInstance.destroy();
          chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#6aa84f','#8bbf5b','#b7d7a8','#8b5e3c'] }] },
            options: { responsive:true, maintainAspectRatio:false }
          });
        } else {
          // Chart.js not loaded â€” show simple text summary
          ctx.parentNode.innerHTML = `<div class="small muted">Chart unavailable (Chart.js not loaded). Summary: ${labels.map((l,i)=>`${l}: ${data[i]||0}`).join(', ') || 'No data'}</div>`;
        }
      } catch(err) {
        console.error('Chart render error', err);
      }
    }

    // Simple modules: Livestock, Feed, Production, Health, Inventory, Reports, Users, Settings
    // For brevity these functions are simplified but fully functional in the demo.
    function renderMyLivestock() {
      const livestock = read(LS_LIVESTOCK);
      const visible = livestock;
      const app = document.getElementById('app');
      if (!app) return;
      app.innerHTML = `
        <section class="panel">
          <h2>My Livestock</h2>
          <p class="small">View and update animal details. Users can report health issues and record daily activities.</p>
          <div class="panel">
            <button class="primary" onclick="openAddAnimal()">Add Animal</button>
            <button class="ghost" onclick="importSampleAnimals()">Load Sample Animals</button>
          </div>
          <div class="panel table-responsive">
            <table class="table">
              <thead><tr><th>Tag</th><th>Type</th><th>Breed</th><th>DOB</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody>
                ${visible.map(a => `<tr>
                  <td>${escapeHtml(a.tag_id)}</td>
                  <td>${escapeHtml(a.type)}</td>
                  <td>${escapeHtml(a.breed)}</td>
                  <td>${escapeHtml(a.dob || '')}</td>
                  <td>${escapeHtml(a.status)}</td>
                  <td>
                    <button onclick="viewAnimal('${a.id}')">View</button>
                    ${currentUser && currentUser.role === 'admin' ? `<button onclick="editAnimal('${a.id}')">Edit</button><button onclick="deleteAnimal('${a.id}')">Delete</button>` : `<button onclick="reportIssue('${a.id}')">Report</button>`}
                  </td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        </section>
      `;
    }

    // Inline add / edit / view helpers
    window.openAddAnimal = function() {
      const modalId = 'inline-animal';
      closeInline(modalId);
      const container = document.createElement('div');
      container.id = modalId;
      container.className = 'panel';
      container.innerHTML = `
        <h3>Add Animal</h3>
        <form id="add-animal-form">
          <div class="form-grid">
            <label>Tag ID <input id="a-tag" required /></label>
            <label>Type <input id="a-type" required /></label>
            <label>Breed <input id="a-breed" /></label>
            <label>Date of Birth <input id="a-dob" type="date" /></label>
            <label>Status <input id="a-status" value="Active" /></label>
            <label>Notes <input id="a-notes" /></label>
          </div>
          <div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div>
        </form>
      `;
      document.getElementById('app').prepend(container);
      document.getElementById('add-animal-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newA = {
          id: generateId('a'),
          tag_id: document.getElementById('a-tag').value.trim(),
          type: document.getElementById('a-type').value.trim(),
          breed: document.getElementById('a-breed').value.trim(),
          dob: document.getElementById('a-dob').value,
          status: document.getElementById('a-status').value.trim(),
          notes: document.getElementById('a-notes').value.trim()
        };
        const list = read(LS_LIVESTOCK);
        list.unshift(newA);
        write(LS_LIVESTOCK, list);
        closeInline(modalId);
        renderMyLivestock();
      });
    };

    window.editAnimal = function(id) {
      const a = read(LS_LIVESTOCK).find(x => x.id === id);
      if (!a) return alert('Not found');
      const modalId = 'inline-edit-animal';
      closeInline(modalId);
      const container = document.createElement('div');
      container.id = modalId;
      container.className = 'panel';
      container.innerHTML = `
        <h3>Edit Animal</h3>
        <form id="edit-animal-form">
          <div class="form-grid">
            <label>Tag ID <input id="e-tag" value="${escapeHtml(a.tag_id)}" required /></label>
            <label>Type <input id="e-type" value="${escapeHtml(a.type)}" required /></label>
            <label>Breed <input id="e-breed" value="${escapeHtml(a.breed)}" /></label>
            <label>DOB <input id="e-dob" type="date" value="${escapeHtml(a.dob||'')}" /></label>
            <label>Status <input id="e-status" value="${escapeHtml(a.status)}" /></label>
            <label>Notes <input id="e-notes" value="${escapeHtml(a.notes)}" /></label>
          </div>
          <div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div>
        </form>
      `;
      document.getElementById('app').prepend(container);
      document.getElementById('edit-animal-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const list = read(LS_LIVESTOCK).map(x => x.id === id ? {
          ...x,
          tag_id: document.getElementById('e-tag').value.trim(),
          type: document.getElementById('e-type').value.trim(),
          breed: document.getElementById('e-breed').value.trim(),
          dob: document.getElementById('e-dob').value,
          status: document.getElementById('e-status').value.trim(),
          notes: document.getElementById('e-notes').value.trim()
        } : x);
        write(LS_LIVESTOCK, list);
        closeInline(modalId);
        renderMyLivestock();
      });
    };

    window.viewAnimal = function(id) {
      const a = read(LS_LIVESTOCK).find(x => x.id === id);
      if (!a) return alert('Not found');
      const health = read(LS_HEALTH).filter(h => h.animal_id === id);
      const production = read(LS_PROD).filter(p => p.animal_id === id);
      const modalId = 'inline-view-animal';
      closeInline(modalId);
      const container = document.createElement('div');
      container.id = modalId;
      container.className = 'panel';
      container.innerHTML = `
        <h3>Animal: ${escapeHtml(a.tag_id)}</h3>
        <div><strong>Type:</strong> ${escapeHtml(a.type)} &nbsp; <strong>Breed:</strong> ${escapeHtml(a.breed)}</div>
        <div style="margin-top:8px"><strong>DOB:</strong> ${escapeHtml(a.dob || '')} &nbsp; <strong>Status:</strong> ${escapeHtml(a.status)}</div>
        <div style="margin-top:10px"><strong>Notes:</strong> ${escapeHtml(a.notes)}</div>
        <hr/>
        <h4>Health / Vaccination History</h4>
        ${health.length ? `<ul>${health.map(h=>`<li>${escapeHtml(h.date)} - ${escapeHtml(h.note)}</li>`).join('')}</ul>` : '<div class="small muted">No health records.</div>'}
        <h4>Production</h4>
        ${production.length ? `<div class="table-responsive"><table class="table"><thead><tr><th>Date</th><th>Type</th><th>Amount</th></tr></thead><tbody>${production.map(p=>`<tr><td>${escapeHtml(p.date)}</td><td>${escapeHtml(p.type)}</td><td>${escapeHtml(p.amount)} ${escapeHtml(p.unit)}</td></tr>`).join('')}</tbody></table></div>` : '<div class="small muted">No production entries.</div>'}
        <div class="actions" style="margin-top:12px">
          <button class="primary" onclick="closeInline('${modalId}')">Close</button>
        </div>`;
      document.getElementById('app').prepend(container);
    };

    window.deleteAnimal = function(id) {
      if (!confirm('Delete this animal?')) return;
      const list = read(LS_LIVESTOCK).filter(x => x.id !== id);
      write(LS_LIVESTOCK, list);
      renderMyLivestock();
    };

    window.reportIssue = function(id) {
      const note = prompt('Describe the issue or health concern:');
      if (!note) return;
      const rec = { id: generateId('h'), animal_id: id, date: new Date().toISOString().slice(0,10), note, reported_by: currentUser ? currentUser.username : 'anonymous' };
      const health = read(LS_HEALTH);
      health.unshift(rec);
      write(LS_HEALTH, health);
      alert('Issue reported (demo).');
      renderMyLivestock();
    };

    // Simplified Feed / Production / Health / Inventory / Reports / Users / Settings
    // Implemented similarly with responsive table wrappers; for brevity only core functions shown below:

    function renderFeed() {
      const list = read(LS_FEED);
      const app = document.getElementById('app');
      if (!app) return;
      app.innerHTML = `
        <section class="panel">
          <h2>Feed & Nutrition</h2>
          <p class="small">Manage feed inventory, record consumption, and allocate feeds to animals/groups.</p>
          <div class="panel">
            <button class="primary" onclick="openAddFeed()">Add Feed Item</button>
            <button class="ghost" onclick="exportJSON('${LS_FEED}','feed-items.json')">Export Feed</button>
          </div>
          <div class="panel table-responsive">
            <table class="table">
              <thead><tr><th>Name</th><th>Quantity</th><th>Unit</th><th>Low Threshold</th><th>Actions</th></tr></thead>
              <tbody>
                ${list.map(f => `<tr><td>${escapeHtml(f.name)}</td><td>${f.quantity}</td><td>${escapeHtml(f.unit)}</td><td>${f.low_stock_threshold||''}</td>
                  <td><button onclick="openEditFeed('${f.id}')">Edit</button><button onclick="consumeFeed('${f.id}')">Consume</button><button onclick="deleteFeed('${f.id}')">Delete</button></td></tr>`).join('')}
              </tbody>
            </table>
          </div>
        </section>`;
    }

    window.openAddFeed = function() {
      const modalId = 'inline-add-feed'; closeInline(modalId);
      const container = document.createElement('div'); container.id = modalId; container.className='panel';
      container.innerHTML = `
        <h3>Add Feed Item</h3>
        <form id="add-feed-form">
          <div class="form-grid">
            <label>Name <input id="f-name" required /></label>
            <label>Quantity <input id="f-qty" type="number" value="0" /></label>
            <label>Unit <input id="f-unit" value="kg" /></label>
            <label>Low stock threshold <input id="f-threshold" type="number" value="10" /></label>
          </div>
          <div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div>
        </form>`;
      document.getElementById('app').prepend(container);
      document.getElementById('add-feed-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const item = { id: generateId('f'), name: document.getElementById('f-name').value.trim(), quantity: Number(document.getElementById('f-qty').value)||0, unit: document.getElementById('f-unit').value.trim(), low_stock_threshold: Number(document.getElementById('f-threshold').value)||0 };
        const list = [item, ...read(LS_FEED)]; write(LS_FEED, list); closeInline(modalId); renderFeed();
      });
    };

    window.openEditFeed = function(id) {
      const f = read(LS_FEED).find(x => x.id === id); if (!f) return;
      const modalId = 'inline-edit-feed'; closeInline(modalId);
      const container = document.createElement('div'); container.id = modalId; container.className='panel';
      container.innerHTML = `
        <h3>Edit Feed</h3>
        <form id="edit-feed-form">
          <div class="form-grid">
            <label>Name <input id="ef-name" value="${escapeHtml(f.name)}" required /></label>
            <label>Quantity <input id="ef-qty" type="number" value="${escapeHtml(f.quantity)}" /></label>
            <label>Unit <input id="ef-unit" value="${escapeHtml(f.unit)}" /></label>
            <label>Low stock threshold <input id="ef-threshold" type="number" value="${escapeHtml(f.low_stock_threshold||0)}" /></label>
          </div>
          <div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div>
        </form>`;
      document.getElementById('app').prepend(container);
      document.getElementById('edit-feed-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const updated = read(LS_FEED).map(x => x.id === id ? { ...x, name: document.getElementById('ef-name').value.trim(), quantity: Number(document.getElementById('ef-qty').value)||0, unit: document.getElementById('ef-unit').value.trim(), low_stock_threshold: Number(document.getElementById('ef-threshold').value)||0 } : x);
        write(LS_FEED, updated); closeInline(modalId); renderFeed();
      });
    };

    window.consumeFeed = function(id) {
      const qty = Number(prompt('Amount consumed (in item unit):', '0')); if (!qty && qty !== 0) return;
      const list = read(LS_FEED).map(x => x.id === id ? { ...x, quantity: (Number(x.quantity)||0) - qty } : x);
      write(LS_FEED, list); alert('Feed consumption recorded (demo).'); renderFeed();
    };

    window.deleteFeed = function(id) { if (!confirm('Delete feed item?')) return; const list = read(LS_FEED).filter(x => x.id !== id); write(LS_FEED, list); renderFeed(); };

    // Production (simplified)
    function renderProduction() {
      const list = read(LS_PROD); const app = document.getElementById('app'); if (!app) return;
      app.innerHTML = `<section class="panel"><h2>Production Records</h2><p class="small">Record daily outputs like milk, eggs, or meat.</p><div class="panel"><button class="primary" onclick="openAddProduction()">Add Production</button><button class="ghost" onclick="exportJSON('${LS_PROD}','production.json')">Export Production</button></div><div class="panel table-responsive"><table class="table"><thead><tr><th>Date</th><th>Animal/Group</th><th>Type</th><th>Amount</th><th>Unit</th><th>Actions</th></tr></thead><tbody>${list.map(p=>`<tr><td>${escapeHtml(p.date)}</td><td>${escapeHtml(p.subject || 'â€”')}</td><td>${escapeHtml(p.type)}</td><td>${escapeHtml(p.amount)}</td><td>${escapeHtml(p.unit)}</td><td><button onclick="deleteProduction('${p.id}')">Delete</button></td></tr>`).join('')}</tbody></table></div></section>`; }

    window.openAddProduction = function() {
      const modalId='inline-add-prod'; closeInline(modalId);
      const container=document.createElement('div'); container.id=modalId; container.className='panel';
      container.innerHTML = `<h3>Add Production</h3><form id="add-prod-form"><div class="form-grid"><label>Date <input id="p-date" type="date" value="${new Date().toISOString().slice(0,10)}" required /></label><label>Animal/Group <input id="p-subject" placeholder="TAG-001 or Herd A" /></label><label>Type <select id="p-type"><option>Milk</option><option>Eggs</option><option>Meat</option></select></label><label>Amount <input id="p-amount" type="number" value="0" /></label><label>Unit <input id="p-unit" value="kg" /></label></div><div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div></form>`;
      document.getElementById('app').prepend(container);
      document.getElementById('add-prod-form').addEventListener('submit', (e)=>{ e.preventDefault(); const rec={ id: generateId('p'), date: document.getElementById('p-date').value, subject: document.getElementById('p-subject').value.trim(), type: document.getElementById('p-type').value, amount: Number(document.getElementById('p-amount').value)||0, unit: document.getElementById('p-unit').value }; const list=[rec, ...read(LS_PROD)]; write(LS_PROD, list); closeInline(modalId); renderProduction(); });
    };
    window.deleteProduction = function(id){ if(!confirm('Delete production record?')) return; const list = read(LS_PROD).filter(x=>x.id!==id); write(LS_PROD, list); renderProduction(); };

    // Health
    function renderHealth() {
      const list = read(LS_HEALTH); const app = document.getElementById('app'); if (!app) return;
      app.innerHTML = `<section class="panel"><h2>Health & Veterinary</h2><p class="small">Manage vaccinations, treatments, and visit logs.</p><div class="panel"><button class="primary" onclick="openAddHealth()">Add Health Record</button><button class="ghost" onclick="exportJSON('${LS_HEALTH}','health.json')">Export Health Records</button></div><div class="panel table-responsive"><table class="table"><thead><tr><th>Date</th><th>Animal</th><th>Note</th><th>Reported By</th><th>Actions</th></tr></thead><tbody>${list.map(h=>`<tr><td>${escapeHtml(h.date)}</td><td>${escapeHtml(h.animal_tag || 'â€”')}</td><td>${escapeHtml(h.note)}</td><td>${escapeHtml(h.reported_by || '')}</td><td><button onclick="deleteHealth('${h.id}')">Delete</button></td></tr>`).join('')}</tbody></table></div></section>`; }
    window.openAddHealth = function(){ const modalId='inline-add-health'; closeInline(modalId); const container=document.createElement('div'); container.id=modalId; container.className='panel'; container.innerHTML = `<h3>Add Health Record</h3><form id="add-health-form"><div class="form-grid"><label>Date <input id="h-date" type="date" value="${new Date().toISOString().slice(0,10)}" /></label><label>Animal Tag <input id="h-tag" placeholder="TAG-001" /></label><label>Note <input id="h-note" /></label><label>Reported by <input id="h-by" value="${currentUser ? currentUser.username : ''}" /></label></div><div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div></form>`; document.getElementById('app').prepend(container); document.getElementById('add-health-form').addEventListener('submit', e=>{ e.preventDefault(); const rec={ id: generateId('h'), date: document.getElementById('h-date').value, animal_tag: document.getElementById('h-tag').value.trim(), note: document.getElementById('h-note').value.trim(), reported_by: document.getElementById('h-by').value.trim() }; const list=[rec,...read(LS_HEALTH)]; write(LS_HEALTH,list); closeInline(modalId); renderHealth(); }); };
    window.deleteHealth = function(id){ if(!confirm('Delete health record?')) return; const list = read(LS_HEALTH).filter(x=>x.id!==id); write(LS_HEALTH,list); renderHealth(); };

    // Inventory
    function renderInventory(){ const list=read(LS_INV); const app=document.getElementById('app'); if(!app) return; app.innerHTML=`<section class="panel"><h2>Inventory</h2><p class="small">Track equipment, medicines, and supplies.</p><div class="panel"><button class="primary" onclick="openAddInventory()">Add Item</button><button class="ghost" onclick="exportJSON('${LS_INV}','inventory.json')">Export Inventory</button></div><div class="panel table-responsive"><table class="table"><thead><tr><th>Item</th><th>Qty</th><th>Location</th><th>Condition</th><th>Actions</th></tr></thead><tbody>${list.map(i=>`<tr><td>${escapeHtml(i.name)}</td><td>${i.qty}</td><td>${escapeHtml(i.location)}</td><td>${escapeHtml(i.condition)}</td><td><button onclick="reportInventory('${i.id}')">Report</button><button onclick="deleteInventory('${i.id}')">Delete</button></td></tr>`).join('')}</tbody></table></div></section>`;}
    window.openAddInventory = function(){ const modalId='inline-add-inv'; closeInline(modalId); const container=document.createElement('div'); container.id=modalId; container.className='panel'; container.innerHTML=`<h3>Add Inventory Item</h3><form id="add-inv-form"><div class="form-grid"><label>Name <input id="i-name" required /></label><label>Quantity <input id="i-qty" type="number" value="1" /></label><label>Location <input id="i-loc" /></label><label>Condition <input id="i-cond" value="Good" /></label></div><div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div></form>`; document.getElementById('app').prepend(container); document.getElementById('add-inv-form').addEventListener('submit', e=>{ e.preventDefault(); const item={ id: generateId('inv'), name: document.getElementById('i-name').value.trim(), qty: Number(document.getElementById('i-qty').value)||0, location: document.getElementById('i-loc').value.trim(), condition: document.getElementById('i-cond').value.trim() }; const list=[item,...read(LS_INV)]; write(LS_INV,list); closeInline(modalId); renderInventory(); }); };
    window.reportInventory = function(id){ const note = prompt('Describe issue (damaged/missing):'); if(!note) return; alert('Report submitted (demo).'); const list = read(LS_INV).map(x => x.id === id ? { ...x, notes: (x.notes || '') + `\\n[${new Date().toISOString().slice(0,10)}] ${note}` } : x); write(LS_INV, list); renderInventory(); };
    window.deleteInventory = function(id){ if(!confirm('Delete item?')) return; const list=read(LS_INV).filter(x=>x.id!==id); write(LS_INV,list); renderInventory(); };

    // Reports & Users & Settings (simplified)
    function renderReports() {
      const prods = read(LS_PROD);
      const fin = read(LS_FIN);
      const totalIncome = fin.filter(f => f.type === 'income').reduce((s,i) => s + (Number(i.amount)||0),0);
      const totalExpense = fin.filter(f => f.type === 'expense').reduce((s,i) => s + (Number(i.amount)||0),0);
      const app = document.getElementById('app'); if(!app) return;
      app.innerHTML = `<section class="panel"><h2>Reports & Analytics</h2><div style="display:flex;gap:12px;flex-wrap:wrap"><div style="background:#f8fff6;padding:12px;border-radius:10px"><div class="small">Production Records</div><div style="font-weight:700">${prods.length}</div></div><div style="background:#fff6f0;padding:12px;border-radius:10px"><div class="small">Total Income</div><div style="font-weight:700">${totalIncome}</div></div><div style="background:#f8f9ff;padding:12px;border-radius:10px"><div class="small">Total Expense</div><div style="font-weight:700">${totalExpense}</div></div></div><div style="margin-top:12px"><h4>Recent Production</h4>${prods.length ? `<div class="table-responsive"><table class="table"><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Subject</th></tr></thead><tbody>${prods.slice(0,20).map(p=>`<tr><td>${escapeHtml(p.date)}</td><td>${escapeHtml(p.type)}</td><td>${escapeHtml(p.amount)}</td><td>${escapeHtml(p.subject||'')}</td></tr>`).join('')}</tbody></table></div>` : '<div class="small muted">No production records.</div>'}</div></section>`; }

    function renderUsers() {
      if (!currentUser || currentUser.role !== 'admin') return alert('Admin only');
      const users = read(LS_USERS);
      const app = document.getElementById('app'); if(!app) return;
      app.innerHTML = `<section class="panel"><h2>User Management</h2><p class="small">Add or remove users, assign roles, and manage access.</p><div class="panel"><button class="primary" onclick="openAddUser()">Add User</button><button class="ghost" onclick="exportJSON('${LS_USERS}','users.json')">Export Users</button></div><div class="panel table-responsive"><table class="table"><thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead><tbody>${users.map(u=>`<tr><td>${escapeHtml(u.username)}</td><td>${escapeHtml(u.name||'')}</td><td>${escapeHtml(u.role)}</td><td><button onclick="editUser('${u.id}')">Edit</button>${u.username !== 'admin' ? `<button onclick="deleteUser('${u.id}')">Delete</button>` : ''}</td></tr>`).join('')}</tbody></table></div></section>`; }

    window.openAddUser = function() {
      if (!currentUser || currentUser.role !== 'admin') return alert('Admin only');
      const modalId='inline-add-user'; closeInline(modalId);
      const container=document.createElement('div'); container.id=modalId; container.className='panel';
      container.innerHTML = `<h3>Add User</h3><form id="add-user-form"><div class="form-grid"><label>Username <input id="u-username" required /></label><label>Password <input id="u-password" type="password" required /></label><label>Name <input id="u-name" /></label><label>Role <select id="u-role"><option>user</option><option>admin</option></select></label></div><div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div></form>`;
      document.getElementById('app').prepend(container);
      document.getElementById('add-user-form').addEventListener('submit', e => { e.preventDefault(); const users = read(LS_USERS); const newUser = { id: generateId('u'), username: document.getElementById('u-username').value.trim(), password: document.getElementById('u-password').value, name: document.getElementById('u-name').value.trim(), role: document.getElementById('u-role').value }; users.unshift(newUser); write(LS_USERS, users); closeInline(modalId); renderUsers(); });
    };

    window.editUser = function(id) {
      if (!currentUser || currentUser.role !== 'admin') return alert('Admin only');
      const u = read(LS_USERS).find(x => x.id === id); if(!u) return;
      const modalId='inline-edit-user'; closeInline(modalId);
      const container=document.createElement('div'); container.id=modalId; container.className='panel';
      container.innerHTML = `<h3>Edit User</h3><form id="edit-user-form"><div class="form-grid"><label>Username <input id="eu-username" value="${escapeHtml(u.username)}" required /></label><label>Password <input id="eu-password" type="password" placeholder="leave to keep" /></label><label>Name <input id="eu-name" value="${escapeHtml(u.name||'')}" /></label><label>Role <select id="eu-role"><option${u.role==='user'?' selected':''}>user</option><option${u.role==='admin'?' selected':''}>admin</option></select></label></div><div class="actions"><button class="primary" type="submit">Save</button><button type="button" class="ghost" onclick="closeInline('${modalId}')">Cancel</button></div></form>`;
      document.getElementById('app').prepend(container);
      document.getElementById('edit-user-form').addEventListener('submit', e=>{ e.preventDefault(); const users = read(LS_USERS).map(x => x.id === id ? { ...x, username: document.getElementById('eu-username').value.trim(), password: document.getElementById('eu-password').value ? document.getElementById('eu-password').value : x.password, name: document.getElementById('eu-name').value.trim(), role: document.getElementById('eu-role').value } : x); write(LS_USERS, users); closeInline(modalId); renderUsers(); });
    };

    window.deleteUser = function(id){ if(!confirm('Delete user?')) return; const users = read(LS_USERS).filter(x=>x.id!==id); write(LS_USERS, users); renderUsers(); };

    function renderSettings() {
      if (!currentUser || currentUser.role !== 'admin') return alert('Admin only');
      const settings = { farmName: 'Demo Farm', timezone: 'UTC' };
      const app = document.getElementById('app'); if(!app) return;
      app.innerHTML = `<section class="panel"><h2>Settings</h2><p class="small">Customize farm profile, data backup, and system configurations.</p><div class="panel"><h4>Farm Profile</h4><div class="form-grid"><label>Farm name <input id="s-farm" value="${escapeHtml(settings.farmName)}" /></label><label>Timezone <input id="s-tz" value="${escapeHtml(settings.timezone)}" /></label></div><div class="actions" style="margin-top:12px"><button class="primary" onclick="alert('Saved (demo)')">Save</button><button class="ghost" onclick="exportAll()">Backup (Export All JSON)</button></div></div></section>`; }

    function exportAll() {
      const data = { users: read(LS_USERS), livestock: read(LS_LIVESTOCK), feed: read(LS_FEED), production: read(LS_PROD), health: read(LS_HEALTH), inventory: read(LS_INV), financials: read(LS_FIN) };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `farm-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
    }

    // Inline close / export utilities
    function closeInline(id) { const el = document.getElementById(id); if (el) el.remove(); }
    window.exportJSON = function(lsKey, filename='export.json') { const blob = new Blob([JSON.stringify(read(lsKey), null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href); };

    // Chatbot (UI-only)
    function toggleChat(e){ if(e && e.stopPropagation) e.stopPropagation(); chatOpen = !chatOpen; const el=document.getElementById('chatbot'); if(chatOpen){ el.classList.remove('closed'); el.setAttribute('aria-hidden','false'); } else { el.classList.add('closed'); el.setAttribute('aria-hidden','true'); } renderChatHistory(); }
    function sendChat(e){ e.preventDefault(); const input = document.getElementById('chat-input'); const text = input && input.value && input.value.trim(); if(!text) return; appendChat('user', text); input.value=''; setTimeout(()=>{ appendChat('bot', farmBotReply(text)); }, 250); }
    function appendChat(who, text){ const body = document.getElementById('chat-body'); if(!body) return; const row=document.createElement('div'); row.style.marginBottom='8px'; if(who==='user'){ row.innerHTML=`<div style="text-align:right"><div style="display:inline-block;background:#e9f7ee;padding:8px;border-radius:8px">${escapeHtml(text)}</div></div>`; } else { row.innerHTML=`<div style="text-align:left"><div style="display:inline-block;background:#fff;padding:8px;border-radius:8px">${escapeHtml(text)}</div></div>`; } body.appendChild(row); body.scrollTop = body.scrollHeight; saveChatHistory(); }
    function farmBotReply(text){ const t=text.toLowerCase(); if(t.includes('help')||t.includes('how')) return "You can add records under each module. For capstone recommendations ask 'capstone'."; if(t.includes('capstone')||t.includes('thesis')) return "For a strong capstone: add backend + DB, RBAC, offline sync, mapping, IoT sensors, analytics/forecasting, and evaluation."; if(t.includes('export')||t.includes('backup')) return "Use Settings â†’ Backup (Export All JSON) to download data."; if(t.includes('sample')){ importSampleAnimals(); return "Sample animals loaded."; } return "Sorry, I didn't get that. Try: 'How to add an animal?', 'capstone recommendations', or 'export'."; }
    function renderChatHistory(){ const body = document.getElementById('chat-body'); if(!body) return; body.innerHTML=''; const history = read(LS_CHAT); history.forEach(h => appendChat(h.who, h.text)); }
    function saveChatHistory(){ const body=document.getElementById('chat-body'); if(!body) return; const nodes=Array.from(body.children); const history = nodes.map(n=>{ const text = n.innerText.trim(); const isUser = n.innerHTML.includes('text-align:right'); return {who:isUser?'user':'bot', text}; }).slice(-50); write(LS_CHAT, history); }

    // small helpers
    window.importSampleAnimals = function(){ const sample=[ { id: generateId('a'), tag_id: 'TAG-101', type: 'Cow', breed: 'Jersey', dob: '2020-01-12', status: 'Active', notes: 'High-yield' }, { id: generateId('a'), tag_id: 'TAG-102', type: 'Chicken', breed: 'Rhode Island', dob: '2023-05-01', status: 'Active', notes: 'Egg layers' } ]; const list=[...sample,...read(LS_LIVESTOCK)]; write(LS_LIVESTOCK, list); alert('Sample animals imported.'); renderMyLivestock(); };

    // keyboard accessibility: Escape closes overlays
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeLogin(); closeMobileNavPanel(); const inline = document.querySelectorAll('[id^="inline-"]'); inline.forEach(n=>n.remove()); if(chatOpen) toggleChat(); } });

    // click outside to close mobile nav
    document.addEventListener('click', (e)=>{ const panel = document.getElementById('mobile-nav-panel'); const hamburger = document.getElementById('hamburger'); if(!panel) return; if(mobileNavOpen && !panel.contains(e.target) && !hamburger.contains(e.target)) closeMobileNavPanel(); });

    // initial UI
    updateHeader();
    navigate('dashboard');

    // restore chat history
    const chatHistory = read(LS_CHAT);
    if (chatHistory.length) chatHistory.forEach(h => appendChat(h.who, h.text));

    // Expose a few functions globally so mobile panel buttons can call them
    window.toggleMobileNav = toggleMobileNav;
    window.toggleChat = toggleChat;
    window.openLogin = openLogin;
    window.closeInline = closeInline;
    window.exportJSON = exportJSON;
  })();
  </script>
</body>
</html>

